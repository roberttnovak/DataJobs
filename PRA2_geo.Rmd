---
title: 'Tipologia y Ciclo de Vida de los Datos. Práctica 2: Limpieza de datos'
author: "Autor: Geovanny Risco"
date: "Diciembre 2021"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    df_print: kable
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T, message=F, warning=F)
```

******
# Descripción del conjunto de datos
******

* Origen del dataset: [https://www.kaggle.com/rashikrahmanpritom/data-science-job-posting-on-glassdoor](https://www.kaggle.com/rashikrahmanpritom/data-science-job-posting-on-glassdoor) 

```{r}
df <- read.csv("Uncleaned_DS_jobs.csv")
str(df)
summary(df)
head(df)
```

El dataset proviene de un scraping de la web Glassdoor. El nombre de las variables son bastantes descriptivos pero sus datos se encuentran desordenados y poco normalizados.

Empezaremos limpiando las variables categóricas. Primero, quitaremos los espacios en blancos y demás signos de puntuación:

```{r}
if (!require('tidyverse')) install.packages('tidyverse')

# Quitamos posibles espacios en blanco al principio y al final (trimws), pasamos todo a minúscula y quitamos simbolos de puntuación.
jobs.title <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Job.Title)))
salary <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Salary.Estimate)))
company.name <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Company.Name))) 
location <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Location))) 
headquarters <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Headquarters))) 
size <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Size))) 
type.of.ownership <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Type.of.ownership))) 
industry <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Industry))) 
sector <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Sector))) 
revenue <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Revenue))) 
competitors <- gsub('[[:punct:]]+',' ',tolower(str_trim(df$Competitors))) 
```

Ahora procederemos a limpiar cada de estas variables categóricas individualmente: 

  * Jobs Title:
  
```{r}
# Datos de partida
head(sort(table(jobs.title), decreasing=T))

# Reducimos la cantidad de titulos de trabajo a los 4 por excelencia.
data.jobs.title <- "data scientist|data engineer|data analyst|machine learning engineer"
jobs.title <- str_extract(jobs.title, data.jobs.title)
table(jobs.title)

# Añadimos las nueva variable "limpia" al dataset
df["Jobs.Title.Simplified"] <- jobs.title
```

  * Salary
  
```{r}
# Datos de partida
sort(table(salary), decreasing=T)

# Eliminamos la muletilla "glassdoor est" y "k" 
salary <- str_trim(str_remove_all(salary, "glassdoor est|k"))

# Separamos el rango salarial en 3: mínimo, máximo y promedio
salary <- str_split(salary, " ", n=2, simplify = T)
salary_min <- as.integer(salary[,1]) * 1000 # Multiplicamos por mil para mantener la consistencia (K)
salary_min
salary_max <- as.integer(salary[,2]) * 1000
salary_max
salary_avg <- (salary_min + salary_max) / 2
sort(table(salary_avg), decreasing = T)

# Guardamos estas nuevas variables en el dataset
df["Salary.Min"] <- salary_min
df["Salary.Max"] <- salary_max
df["Salary.AVG"] <- salary_avg
```

  * Company Names
  
```{r}
# Datos de partida
sort(table(company.name), decreasing=T)

# Eliminamos la muletilla del final `\n` más lo de después
company.name <- str_remove_all(company.name, "\n.*")
head(sort(table(company.name), decreasing=T))

# Guardamos esta nueva variable "limpia" en el dataset. En este caso, sustituimos la original
df$Company.Name <- company.name
```

  * Location -> No hace falta hacer nada
  
```{r}
head(sort(table(df$Location), decreasing =T))
```
  
  * Headquarters -> ponemos -1 como NA
  
```{r}
df$Headquarters[df$Headquarters==-1] <- NA
head(sort(table(df$Headquarters), decreasing = T))

```

  
  * Size -> 
  
  * Type of ownership -> -1 y Unknown por NA
  
```{r}
df <- df %>%
  mutate(
    Type.of.ownership = ifelse(Type.of.ownership %in% c("-1", "Unknown"), NA, Type.of.ownership)
  )
summary(as_factor(df$Type.of.ownership))
```

  
  * Industry 
  
  * Sector 
  
  * Revenue 
  
  * Competitors -> -1 por NA

******
# Limpieza de datos
******

## Valores perdidos o *missings*

```{r}
summary(df)
```


## Valores extremos o *outliers*

```{r}
boxplot(df$Salary.AVG, main="Salario promedio")
boxplot.stats(df$Salary.AVG)$out
```


## Reducción de dimensionalidad


******
# Feature engineering
******

## Seleccionar variables (*Feature Selection*)


## Nuevas variables

  * Location in Headquarters: Nueva columna binaria a partir de Location y Headquarters
  
```{r}
df %>% 
  mutate(
    LocationInHeadquarters = Location == Headquarters
  )
```

  * Programming languages:
  
```{r}
head(df$Job.Description)
main.programming.lang <- c("python| r |scala|java|c\\+\\+")
df %>%
  mutate(
    `Programming.Languages` = sapply(str_extract_all(str_to_lower(Job.Description), main.programming.lang, simplify =F), unique)
  )
```
  
  * Seniority:
  

******
# Exploratory analysis
******

## Correlaciones


## Test estadísticos


### Comprobación de la normalidad


### Comprobación de la homocestadisticidad


******
# Analysis
******




  



